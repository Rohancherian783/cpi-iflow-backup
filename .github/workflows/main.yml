name: Backup ALL SAP CPI iFlows

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backup_all_iflows:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Fetch list of all iFlows
        id: get_iflows
        run: |
          echo "Fetching list of all iFlows..."
          curl -u "${{ secrets.CPI_USERNAME }}:${{ secrets.CPI_PASSWORD }}" \
            -X GET "${{ secrets.CPI_TENANT }}/api/v1/IntegrationDesigntimeArtifacts?\$expand=Artifacts" \
            -o iflow_list.xml

          echo "List downloaded:"
          cat iflow_list.xml

          # Extract all iFlow IDs and Versions
          ids=$(xmllint --xpath "//d:entry/d:content/m:properties/m:Id/text()" iflow_list.xml 2>/dev/null || true)
          versions=$(xmllint --xpath "//d:entry/d:content/m:properties/m:Version/text()" iflow_list.xml 2>/dev/null || true)

          echo "iFlow IDs found:"
          echo "$ids"
          echo "Versions found:"
          echo "$versions"

          printf "%s\n" $ids > ids.txt
          printf "%s\n" $versions > versions.txt

      - name: Export each iFlow
        run: |
          paste ids.txt versions.txt | while read id version; do
            echo "Exporting $id (version $version)..."

            curl -u "${{ secrets.CPI_USERNAME }}:${{ secrets.CPI_PASSWORD }}" \
              -X GET "${{ secrets.CPI_TENANT }}/api/v1/IntegrationDesigntimeArtifacts(Id='${id}',Version='${version}')/%24value" \
              -o "${id}_${version}.zip"

            echo "Exported: ${id}_${version}.zip"
          done

      - name: Commit and Push Backup
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Backup ALL CPI iFlows (full tenant backup)" || echo "No changes"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git --force





