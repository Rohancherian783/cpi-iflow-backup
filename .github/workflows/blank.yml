name: Backup SAP CPI iFlows

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # DEBUG: print your URL (optional)
    - name: Debug URL
      run: |
        echo "Tenant URL: '${{ secrets.CPI_TENANT }}'"

    - name: Fetch iFlow List
      id: list
      run: |
        echo "Fetching available iFlows..."

        curl -u "${{ secrets.CPI_USERNAME }}:${{ secrets.CPI_PASSWORD }}" \
        "${{ secrets.CPI_TENANT }}/itspaces/odata/api/v1/IntegrationDesigntimeArtifacts" \
        -o iflows.xml

        grep -oP '(?<=<Id>).*?(?=</Id>)' iflows.xml > iflows.txt

        echo "iFlows found:"
        cat iflows.txt

    - name: Export iFlows
      run: |
        mkdir -p backup
        while IFS= read -r IFLOW_ID; do
          echo "Exporting: $IFLOW_ID"

          curl -u "${{ secrets.CPI_USERNAME }}:${{ secrets.CPI_PASSWORD }}" \
          "${{ secrets.CPI_TENANT }}/itspaces/odata/api/v1/IntegrationDesigntimeArtifacts('$IFLOW_ID')/\$value" \
          --output "backup/${IFLOW_ID}.zip"

          echo "Export completed: ${IFLOW_ID}.zip"
        done < iflows.txt

    - name: Commit and Push
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "github-actions"

        git add backup/ || true
        git commit -m "Auto Backup - $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push


